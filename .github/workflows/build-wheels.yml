name: Build Wheels

# Manually triggered workflow for testing wheel builds
# Does NOT publish to PyPI - only uploads artifacts for inspection

on:
  workflow_dispatch:
    inputs:
      python_versions:
        description: 'Python versions to build (comma-separated, e.g., "3.11,3.12")'
        required: false
        default: '3.11'
        type: string
      platforms:
        description: 'Platforms to build'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - macos-only
          - linux-only
          - windows-only

env:
  CIBW_BUILD_VERBOSITY: 1

jobs:
  # Determine which platforms to build
  setup:
    name: Setup build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          PLATFORMS='${{ inputs.platforms }}'

          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "macos-only" ]; then
            MACOS='[{"os":"macos","arch":"x86_64","runner":"macos-13","cibw_archs":"x86_64"},{"os":"macos","arch":"arm64","runner":"macos-14","cibw_archs":"arm64"}]'
          else
            MACOS='[]'
          fi

          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "linux-only" ]; then
            LINUX='[{"os":"linux","arch":"x86_64","runner":"ubuntu-latest","cibw_archs":"x86_64"}]'
          else
            LINUX='[]'
          fi

          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "windows-only" ]; then
            WINDOWS='[{"os":"windows","arch":"x86_64","runner":"windows-2022","cibw_archs":"AMD64"}]'
          else
            WINDOWS='[]'
          fi

          # Combine arrays
          MATRIX=$(echo "[$MACOS,$LINUX,$WINDOWS]" | jq -c 'flatten | map(select(. != null))')
          echo "matrix={\"include\":$MATRIX}" >> $GITHUB_OUTPUT
          echo "Building for: $MATRIX"

  build_wheels:
    name: Build ${{ matrix.os }} ${{ matrix.arch }}
    needs: setup
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # macOS dependencies
      - name: Install dependencies (macOS)
        if: matrix.os == 'macos'
        run: |
          brew install cmake ninja

      # Linux dependencies
      - name: Install dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build

      # Windows dependencies
      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        run: |
          choco install cmake ninja -y

      # Build thirdparty libraries
      - name: Build thirdparty (Unix)
        if: matrix.os != 'windows'
        run: |
          python scripts/manage.py build --llama-cpp --whisper-cpp
        env:
          GGML_METAL: ${{ matrix.os == 'macos' && '1' || '0' }}

      - name: Build thirdparty (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          python scripts/manage.py build --llama-cpp --whisper-cpp
        env:
          GGML_METAL: '0'

      # Convert Python versions input to cibuildwheel format
      - name: Set Python versions
        id: py-versions
        shell: bash
        run: |
          # Convert "3.11,3.12" to "cp311-* cp312-*"
          VERSIONS="${{ inputs.python_versions }}"
          CIBW_BUILD=""
          IFS=',' read -ra VER_ARRAY <<< "$VERSIONS"
          for ver in "${VER_ARRAY[@]}"; do
            ver=$(echo "$ver" | tr -d ' ')
            ver_nodot=$(echo "$ver" | tr -d '.')
            CIBW_BUILD="$CIBW_BUILD cp$ver_nodot-*"
          done
          CIBW_BUILD=$(echo "$CIBW_BUILD" | xargs)
          echo "cibw_build=$CIBW_BUILD" >> $GITHUB_OUTPUT
          echo "Building for Python versions: $CIBW_BUILD"

      # Install cibuildwheel
      - name: Install cibuildwheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel==2.21.3

      # Build wheels
      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_BUILD: ${{ steps.py-versions.outputs.cibw_build }}
          CIBW_SKIP: "*-musllinux_*"

          # macOS configuration
          CIBW_ENVIRONMENT_MACOS: >
            MACOSX_DEPLOYMENT_TARGET=11.0
            GGML_METAL=1

          # Linux configuration
          CIBW_ENVIRONMENT_LINUX: >
            GGML_METAL=0
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
          CIBW_BEFORE_ALL_LINUX: |
            yum install -y cmake ninja-build

          # Windows configuration
          CIBW_ENVIRONMENT_WINDOWS: >
            GGML_METAL=0

          # Repair wheels
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
            delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >
            auditwheel repair -w {dest_dir} {wheel}
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: >
            delvewheel repair -w {dest_dir} {wheel}

      # List built wheels
      - name: List built wheels
        shell: bash
        run: |
          echo "=== Built wheels ==="
          ls -lah wheelhouse/
          echo ""
          echo "=== Wheel info ==="
          for wheel in wheelhouse/*.whl; do
            echo "--- $wheel ---"
            python -m zipfile -l "$wheel" | head -20
            echo ""
          done

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          retention-days: 14

  # Build source distribution
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Build sdist
        run: python -m build --sdist

      - name: List sdist contents
        run: |
          echo "=== Source distribution ==="
          ls -lah dist/
          echo ""
          echo "=== Sdist contents ==="
          tar -tzf dist/*.tar.gz | head -50

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 14

  # Summary job
  summary:
    name: Build summary
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Generate summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Built Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Artifact | Files | Total Size |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|------------|" >> $GITHUB_STEP_SUMMARY

          for dir in all-artifacts/*/; do
            if [ -d "$dir" ]; then
              name=$(basename "$dir")
              count=$(find "$dir" -type f | wc -l)
              size=$(du -sh "$dir" | cut -f1)
              echo "| $name | $count | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## All Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find all-artifacts -type f -name "*.whl" -o -name "*.tar.gz" | sort >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Wheel Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for wheel in $(find all-artifacts -name "*.whl" | sort); do
            filename=$(basename "$wheel")
            size=$(ls -lh "$wheel" | awk '{print $5}')
            echo "- **$filename** ($size)" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-artifacts-combined
          path: all-artifacts/
          retention-days: 14
