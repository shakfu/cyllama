name: build-wheels

# Manually triggered workflow for building wheels with cibuildwheel
# Supports multiple Python versions and platforms

on:
  workflow_dispatch:
    inputs:
      python_versions:
        description: 'Python versions to build (comma-separated, e.g., "3.11,3.12")'
        required: false
        default: '3.9,3.10,3.11,3.12,3.13'
        type: string
      platforms:
        description: 'Platforms to build'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - macos-only
          - linux-only
          - windows-only

env:
  CIBW_BUILD_VERBOSITY: 1

jobs:
  # Determine which platforms to build
  setup:
    name: Setup build matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set build matrix
        id: set-matrix
        run: |
          PLATFORMS='${{ inputs.platforms }}'

          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "macos-only" ]; then
            MACOS='[{"os":"macos","arch":"arm64","runner":"macos-14","cibw_archs":"arm64"}]'
          else
            MACOS='[]'
          fi

          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "linux-only" ]; then
            LINUX='[{"os":"linux","arch":"x86_64","runner":"ubuntu-22.04","cibw_archs":"x86_64"}]'
          else
            LINUX='[]'
          fi

          if [ "$PLATFORMS" = "all" ] || [ "$PLATFORMS" = "windows-only" ]; then
            WINDOWS='[{"os":"windows","arch":"x86_64","runner":"windows-2022","cibw_archs":"AMD64"}]'
          else
            WINDOWS='[]'
          fi

          # Combine arrays
          MATRIX=$(echo "[$MACOS,$LINUX,$WINDOWS]" | jq -c 'flatten | map(select(. != null))')
          echo "matrix={\"include\":$MATRIX}" >> $GITHUB_OUTPUT
          echo "Building for: $MATRIX"

  build_wheels:
    name: Build ${{ matrix.os }} ${{ matrix.arch }}
    needs: setup
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv (Unix)
        if: matrix.os != 'windows'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install uv (Windows)
        if: matrix.os == 'windows'
        run: |
          irm https://astral.sh/uv/install.ps1 | iex
          echo "$env:USERPROFILE\.local\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install dependencies (Unix)
        if: matrix.os != 'windows'
        run: make sync

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows'
        shell: bash
        run: scripts/setup.sh

      - name: Sync dependencies (Windows)
        if: matrix.os == 'windows'
        run: uv sync

      # Convert Python versions input to cibuildwheel format
      - name: Set Python versions
        id: py-versions
        shell: bash
        run: |
          # Convert "3.11,3.12" to "cp311-* cp312-*"
          VERSIONS="${{ inputs.python_versions }}"
          CIBW_BUILD=""
          IFS=',' read -ra VER_ARRAY <<< "$VERSIONS"
          for ver in "${VER_ARRAY[@]}"; do
            ver=$(echo "$ver" | tr -d ' ')
            ver_nodot=$(echo "$ver" | tr -d '.')
            CIBW_BUILD="$CIBW_BUILD cp$ver_nodot-*"
          done
          CIBW_BUILD=$(echo "$CIBW_BUILD" | xargs)
          echo "cibw_build=$CIBW_BUILD" >> $GITHUB_OUTPUT
          echo "Building for Python versions: $CIBW_BUILD"

      - name: Install cibuildwheel
        run: |
          python -m pip install --upgrade pip
          python -m pip install cibuildwheel==2.21.3

      - name: Build wheels
        run: python -m cibuildwheel --output-dir wheelhouse
        env:
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_BUILD: ${{ steps.py-versions.outputs.cibw_build }}
          CIBW_SKIP: "*-musllinux_*"

          # macOS configuration
          CIBW_ENVIRONMENT_MACOS: >
            MACOSX_DEPLOYMENT_TARGET=11.0
            GGML_METAL=1

          # Linux configuration
          CIBW_ENVIRONMENT_LINUX: >
            GGML_METAL=0
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
          CIBW_BEFORE_ALL_LINUX: |
            yum install -y cmake ninja-build

          # Windows configuration
          CIBW_ENVIRONMENT_WINDOWS: >
            GGML_METAL=0

          # Repair wheels
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: >
            delocate-wheel --require-archs {delocate_archs} -w {dest_dir} -v {wheel}
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: >
            auditwheel repair -w {dest_dir} {wheel}
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: >
            delvewheel repair -w {dest_dir} {wheel}

      - name: List built wheels
        shell: bash
        run: |
          echo "=== Built wheels ==="
          ls -lah wheelhouse/

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.arch }}
          path: ./wheelhouse/*.whl
          retention-days: 14

  # Build source distribution
  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: make sync

      - name: Build sdist
        run: uv build --sdist

      - name: List sdist contents
        run: |
          echo "=== Source distribution ==="
          ls -lah dist/

      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 14

  # Collect all wheels into a single artifact
  collect:
    name: Collect wheels
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v5
        with:
          path: artifacts
          pattern: wheel-*

      - name: Download sdist
        uses: actions/download-artifact@v5
        with:
          name: sdist
          path: artifacts/sdist

      - name: Collect into single directory
        run: |
          mkdir -p dist
          find artifacts -name "*.whl" -exec cp {} dist/ \;
          find artifacts -name "*.tar.gz" -exec cp {} dist/ \;
          echo "=== Collected distributions ==="
          ls -la dist/

      - name: Generate summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Distributions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          for f in dist/*; do
            filename=$(basename "$f")
            size=$(ls -lh "$f" | awk '{print $5}')
            echo "| $filename | $size |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Upload combined distributions
        uses: actions/upload-artifact@v4
        with:
          name: cyllama-dist-all
          path: dist/*
          retention-days: 14
